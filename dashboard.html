<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hanz Simulator — Dashboard</title>
  <link rel="icon" type="image/x-icon" href="ft.png">

  <style>
    :root{
      --bg: #07121a;
      --card: linear-gradient(180deg,#0f1b26 0%, #0b1620 100%);
      --muted: #9fb0c7;
      --accent: #f6c85f;
      --accent-2: #58a6ff;
      --glass: rgba(255,255,255,0.03);
      --success: #2ea043;
      --danger: #f44753;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 400px at 10% 10%, rgba(9,20,30,0.6), transparent),
                  radial-gradient(900px 300px at 90% 90%, rgba(8,12,20,0.6), transparent),
                  var(--bg);
      color: #e6eef6;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding: 24px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .logo {
      font-weight:800; color:var(--accent); font-size:24px;
    }
    .nav-buttons {
      display: flex;
      gap: 12px;
    }
    .nav-btn {
      padding: 10px 16px;
      border-radius: 8px;
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.05);
      color: var(--muted);
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s;
    }
    .nav-btn:hover {
      background: rgba(255,255,255,0.05);
      color: white;
    }
    .nav-btn.primary {
      background: var(--accent);
      color: #071226;
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    @media (min-width: 1200px) {
      .dashboard-grid {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(3,8,15,0.6);
      border: 1px solid rgba(255,255,255,0.02);
      margin-bottom: 20px;
    }
    .card-title {
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 16px;
      color: var(--accent);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      padding-bottom: 8px;
    }
    .balance-card {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .balance-item {
      display: flex;
      flex-direction: column;
    }
    .balance-label {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .balance-value {
      font-size: 24px;
      font-weight: 800;
      color: var(--accent);
    }
    .portfolio-table {
      width: 100%;
      border-collapse: collapse;
    }
    .portfolio-table th, .portfolio-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.03);
    }
    .portfolio-table th {
      color: var(--accent);
      font-weight: 700;
    }
    .green { color: var(--success); }
    .red { color: var(--danger); }
    .news-item {
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.03);
    }
    .news-item:last-child {
      border-bottom: none;
    }
    .news-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .news-date {
      font-size: 12px;
      color: var(--muted);
    }
    .stock-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.03);
    }
    .stock-item:last-child {
      border-bottom: none;
    }
    .stock-name {
      font-weight: 600;
    }
    .stock-price {
      font-weight: 700;
    }
    .section-title {
      font-weight: 700;
      font-size: 20px;
      margin: 30px 0 20px;
      color: var(--accent);
    }
    .small { font-size: 13px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">Hanz Simulator — Dashboard</div>
      <div class="nav-buttons">
        <a href="saham.html" class="nav-btn primary">Trading</a>
        <a href="admin.html" class="nav-btn">Admin Panel</a>
        <a href="index.html" class="nav-btn">Logout</a>
      </div>
    </div>

    <div class="dashboard-grid">
      <div class="card balance-card">
        <div class="balance-item">
          <div class="balance-label">Saldo Tersedia</div>
          <div class="balance-value" id="availableBalance">Rp 0</div>
        </div>
        <div class="balance-item">
          <div class="balance-label">Total Portfolio</div>
          <div class="balance-value" id="totalPortfolio">Rp 0</div>
        </div>
        <div class="balance-item">
          <div class="balance-label">Profit/Loss Tidak Terealisasi</div>
          <div class="balance-value" id="unrealizedPnl">Rp 0</div>
        </div>
        <div class="balance-item">
          <div class="balance-label">Profit/Loss Terealisasi</div>
          <div class="balance-value" id="realizedPnl">Rp 0</div>
        </div>
      </div>
    </div>

    <div class="dashboard-grid">
      <div class="card">
        <div class="card-title">Portfolio Saat Ini</div>
        <table class="portfolio-table">
          <thead>
            <tr>
              <th>Symbol</th>
              <th>Lots</th>
              <th>Avg Price</th>
              <th>Current</th>
              <th>P/L</th>
              <th>P/L %</th>
            </tr>
          </thead>
          <tbody id="portfolioTableBody">
            </tbody>
        </table>
        <div id="emptyPortfolio" class="small" style="text-align: center; padding: 20px; display: none;">
          Tidak ada posisi aktif. <a href="saham.html" style="color: var(--accent);">Mulai trading</a>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Saham Populer</div>
        <div id="popularStocks">
          </div>
      </div>
      <div class="card">
        <div class="card-title">Berita Saham Terkini</div>
        <div id="newsList">
          </div>
      </div>
    </div>
  </div>
  <script>
  // Constants for localStorage keys (must match saham.html)
  const LS = {
    BAL: 'premium_sim_balance_v1',
    POS: 'premium_sim_positions_v1',
    TR: 'premium_sim_trades_v1',
    REQ: 'premium_sim_requests_v1',
    PRICES: 'premium_sim_prices_v1'
  };

  // Sample popular stocks and news data (as in the original file)
  const POPULAR_STOCKS = [
    'BBRI.JK', 'BBCA.JK', 'TLKM.JK', 'AAPL.US', 'MSFT.US', 'TSLA.US', 'ANTM.JK', 'UNVR.JK', 'ASII.JK'
  ];

  const SAMPLE_NEWS = [
    { title: 'BBRI Catat Kenaikan Laba Bersih 15% di Kuartal I', date: '15 Mei 2023', content: 'PT Bank Rakyat Indonesia (BBRI) mencatatkan kenaikan laba bersih sebesar 15% pada kuartal I tahun 2023.' },
    { title: 'Fed Pertahankan Suku Bunga, Pasar Saham Merespons Positif', date: '14 Mei 2023', content: 'Federal Reserve memutuskan untuk mempertahankan suku bunga acuan, memberikan sentimen positif bagi pasar saham global.' },
    { title: 'TSLA Rilis Laporan Kuartalan yang Lebih Baik dari Perkiraan', date: '13 Mei 2023', content: 'Tesla Inc. melaporkan pendapatan dan laba yang lebih tinggi dari perkiraan analis, mengirimkan sahamnya naik dalam perdagangan setelah jam kerja.' },
    { title: 'BCRA Kembali Intervensi untuk Stabilkan Rupiah', date: '12 Mei 2023', content: 'Bank Indonesia kembali melakukan intervensi di pasar valuta asing untuk menstabilkan nilai tukar rupiah yang melemah.' },
    { title: 'Google Umumkan Peluncuran Fitur AI Baru di Google Docs', date: '11 Mei 2023', content: 'Google mengumumkan fitur-fitur baru berbasis kecerdasan buatan untuk Google Docs, yang diharapkan dapat meningkatkan produktivitas.' },
    { title: 'Harga Minyak Dunia Naik Tipis di Tengah Kekhawatiran Pasokan', date: '10 Mei 2023', content: 'Harga minyak mentah naik sedikit karena pasar mencermati ketidakpastian geopolitik yang dapat mengganggu pasokan.' },
  ];

  // Helper functions (as in the original file)
  const fmtRp = v => v.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
  const fmtPnl = v => {
    const pnlStr = v.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    return (v >= 0 ? '+' : '') + pnlStr;
  };
  const fmtPnlPercent = v => (v >= 0 ? '+' : '') + v.toFixed(2);

  // Core functions to load and calculate data
  function loadData() {
    const balance = Number(localStorage.getItem(LS.BAL)) || 0;
    const positions = JSON.parse(localStorage.getItem(LS.POS)) || {};
    const trades = JSON.parse(localStorage.getItem(LS.TR)) || [];
    const lastPrices = JSON.parse(localStorage.getItem(LS.PRICES)) || {};
    return { balance, positions, trades, lastPrices };
  }

  function calculateUnrealizedPnl(positions, lastPrices) {
    let pnl = 0;
    for (const symbol in positions) {
      const pos = positions[symbol];
      if (pos.lots > 0) {
        const currentPrice = lastPrices[symbol] || pos.avg;
        pnl += (currentPrice - pos.avg) * pos.lots * 100;
      }
    }
    return pnl;
  }

  function calculateRealizedPnl(trades) {
    let pnl = 0;
    trades.forEach(trade => {
      // PnL is calculated on closing trades, which are stored in 'trades'
      if (trade.type === 'SELL' && trade.pnl) {
        pnl += trade.pnl;
      }
    });
    return pnl;
  }

  // UI rendering functions
  function updateBalances(balance, unrealizedPnl, realizedPnl) {
    document.getElementById('availableBalance').textContent = 'Rp ' + fmtRp(Math.round(balance));
    document.getElementById('unrealizedPnl').textContent = 'Rp ' + fmtPnl(Math.round(unrealizedPnl));
    document.getElementById('realizedPnl').textContent = 'Rp ' + fmtRp(Math.round(realizedPnl));

    const totalPortfolio = balance + unrealizedPnl;
    document.getElementById('totalPortfolio').textContent = 'Rp ' + fmtRp(Math.round(totalPortfolio));

    document.getElementById('unrealizedPnl').className = 'balance-value ' + (unrealizedPnl >= 0 ? 'green' : 'red');
    document.getElementById('realizedPnl').className = 'balance-value ' + (realizedPnl >= 0 ? 'green' : 'red');
  }

  function renderPortfolio(positions, lastPrices) {
    const tbody = document.getElementById('portfolioTableBody');
    const emptyMessage = document.getElementById('emptyPortfolio');
    tbody.innerHTML = '';
    let hasPositions = false;

    for (const symbol in positions) {
      const pos = positions[symbol];
      if (pos.lots > 0) {
        hasPositions = true;
        const currentPrice = lastPrices[symbol] || pos.avg;
        const pnl = (currentPrice - pos.avg) * pos.lots * 100;
        const pnlPercent = (pnl / (pos.avg * pos.lots * 100)) * 100;

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${symbol}</td>
          <td>${pos.lots}</td>
          <td>${fmtRp(pos.avg)}</td>
          <td>${fmtRp(currentPrice)}</td>
          <td class="${pnl >= 0 ? 'green' : 'red'}">${fmtRp(pnl)}</td>
          <td class="${pnl >= 0 ? 'green' : 'red'}">${fmtPnlPercent(pnlPercent)}%</td>
        `;
        tbody.appendChild(row);
      }
    }
    emptyMessage.style.display = hasPositions ? 'none' : 'block';
  }

  function renderPopularStocks(lastPrices) {
    const container = document.getElementById('popularStocks');
    container.innerHTML = '';
    POPULAR_STOCKS.forEach(symbol => {
      const currentPrice = lastPrices[symbol] || 0;
      const change = (lastPrices[symbol] - lastPrices[symbol] * (1 + (Math.random() - 0.5) * 0.01)); // Mock change
      const isPositive = change >= 0;
      const priceElement = document.createElement('div');
      priceElement.className = 'stock-item';
      priceElement.innerHTML = `
        <span class="stock-name">${symbol}</span>
        <span class="stock-price ${isPositive ? 'green' : 'red'}">
          Rp ${fmtRp(currentPrice)}
        </span>
      `;
      container.appendChild(priceElement);
    });
  }

  function renderNews() {
    const list = document.getElementById('newsList');
    list.innerHTML = '';
    SAMPLE_NEWS.forEach(news => {
      const newsItem = document.createElement('div');
      newsItem.className = 'news-item';
      newsItem.innerHTML = `
        <div class="news-title">${news.title}</div>
        <div class="news-date">${news.date}</div>
      `;
      list.appendChild(newsItem);
    });
  }

  // NEW: Consolidated update function
  function updateDashboardUI() {
      const { balance, positions, trades, lastPrices } = loadData();
      const unrealizedPnl = calculateUnrealizedPnl(positions, lastPrices);
      const realizedPnl = calculateRealizedPnl(trades);
      updateBalances(balance, unrealizedPnl, realizedPnl);
      renderPortfolio(positions, lastPrices);
      renderPopularStocks(lastPrices);
  }

// Initialization and auto-refresh setup
  function initDashboard() {
    updateDashboardUI(); // Initial render
    renderNews(); // Render news only once as it's static
    setInterval(updateDashboardUI, 1000); // Set up auto-refresh every 1 second
  }

  // Run the initialization function when the page loads
  window.addEventListener('load', initDashboard);

  </script>
</body>
</html>